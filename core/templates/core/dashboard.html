{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard - Business Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'core/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Business Intelligence Dashboard</h1>
            <p class="subtitle">AI-powered insights for your tour business</p>
        </div>
        <div class="header-actions">
            <div class="date-range">
                <span class="date-label">Last 6 Months</span>
                <span class="date-period">{{ months_data.0 }} - {{ months_data|last }}</span>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card revenue">
            <div class="metric-icon">üí∞</div>
            <div class="metric-content">
                <h3>Total Revenue</h3>
                <div class="metric-value">${{ total_revenue|floatformat:0 }}</div>
                <div class="metric-trend positive">
                    <span class="trend-arrow">‚Üó</span>
                    <span class="trend-text">+12.5% vs last period</span>
                </div>
            </div>
        </div>

        <div class="metric-card profit">
            <div class="metric-icon">üìà</div>
            <div class="metric-content">
                <h3>Total Profit</h3>
                <div class="metric-value">${{ total_profit|floatformat:0 }}</div>
                <div class="metric-trend positive">
                    <span class="trend-arrow">‚Üó</span>
                    <span class="trend-text">{{ profit_margin|floatformat:1 }}% margin</span>
                </div>
            </div>
        </div>

        <div class="metric-card departures">
            <div class="metric-icon">üöå</div>
            <div class="metric-content">
                <h3>Total Departures</h3>
                <div class="metric-value">{{ total_departures }}</div>
                <div class="metric-trend">
                    <span class="trend-text">{{ profitable_departures }} profitable</span>
                </div>
            </div>
        </div>

        <div class="metric-card avg-profit">
            <div class="metric-icon">üéØ</div>
            <div class="metric-content">
                <h3>Avg Profit/Departure</h3>
                <div class="metric-value">${{ avg_profit_per_departure|floatformat:0 }}</div>
                <div class="metric-trend">
                    <span class="trend-text">Per departure</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <div class="chart-header">
                <h2>Financial Performance Trends</h2>
                <p>Revenue, Profit, and Costs over the last 6 months</p>
            </div>
            <div class="chart-wrapper">
                <canvas id="financialChart"></canvas>
                <div id="no-data-message" style="display: none; text-align: center; padding: 2rem; color: #64748b;">
                    <p>No financial data available yet. Create some departures to see trends!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Grid -->
    <div class="insights-grid">
        <!-- Top Performing Tours -->
        <div class="insight-card">
            <div class="insight-header">
                <h3>üèÜ Top Performing Tours</h3>
                <p>By total profit generated</p>
            </div>
            <div class="insight-content">
                {% if top_tours %}
                    {% for tour in top_tours %}
                    <div class="tour-item">
                        <div class="tour-info">
                            <div class="tour-name">{{ tour.name }}</div>
                            <div class="tour-stats">
                                <span class="stat">${{ tour.profit|floatformat:0 }} profit</span>
                                <span class="stat">{{ tour.departures }} departures</span>
                            </div>
                        </div>
                        <div class="tour-bar">
                            <div class="bar-fill" style="width: {{ tour.percentage|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No tour data available yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Risk Alerts -->
        <div class="insight-card risk-alerts">
            <div class="insight-header">
                <h3>‚ö†Ô∏è Risk Alerts</h3>
                <p>Departures that need attention</p>
            </div>
            <div class="insight-content">
                {% if risk_departures %}
                    {% for departure in risk_departures %}
                    <div class="risk-item">
                        <div class="risk-info">
                            <div class="risk-title">{{ departure.tour.title }}</div>
                            <div class="risk-date">{{ departure.departure_date|date:"M d, Y" }}</div>
                            <div class="risk-details">
                                <span class="risk-stat">${{ departure.current_profit|floatformat:0 }} profit</span>
                                <span class="risk-stat">{{ departure.slots_filled }}/{{ departure.available_spots }} booked</span>
                            </div>
                        </div>
                        <div class="risk-action">
                            <a href="{% url 'edit_departure' departure.id %}" class="btn btn-sm btn-warning">Review</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No risk alerts - all departures are performing well!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="insight-card quick-actions">
            <div class="insight-header">
                <h3>‚ö° Quick Actions</h3>
                <p>Common tasks and shortcuts</p>
            </div>
            <div class="insight-content">
                <div class="action-grid">
                    <a href="{% url 'document_upload' %}" class="action-item">
                        <div class="action-icon">üìÑ</div>
                        <div class="action-text">Upload Tour Document</div>
                    </a>
                    <a href="{% url 'create_departure' %}" class="action-item">
                        <div class="action-icon">‚ûï</div>
                        <div class="action-text">Create Departure</div>
                    </a>
                    <a href="{% url 'tours' %}" class="action-item">
                        <div class="action-icon">üó∫Ô∏è</div>
                        <div class="action-text">Manage Tours</div>
                    </a>
                    <a href="{% url 'departures' %}" class="action-item">
                        <div class="action-icon">üìä</div>
                        <div class="action-text">Financial Analysis</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing chart...');
    
    // Debug: Check if we have data
    let monthsData = {{ months_data|safe }};
    let revenueData = {{ revenue_data|safe }};
    let profitData = {{ profit_data|safe }};
    let costData = {{ cost_data|safe }};

    console.log('Months data:', monthsData);
    console.log('Revenue data:', revenueData);
    console.log('Profit data:', profitData);
    console.log('Cost data:', costData);

    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        document.getElementById('no-data-message').innerHTML = '<p>Chart library not loaded. Please refresh the page.</p>';
        document.getElementById('no-data-message').style.display = 'block';
        document.getElementById('financialChart').style.display = 'none';
        return;
    } else {
        console.log('Chart.js is loaded successfully');
    }

    // Check if we have any data
    let hasData = monthsData.length > 0 && (revenueData.some(r => r > 0) || profitData.some(p => p > 0) || costData.some(c => c > 0));

    if (!hasData) {
        // Use sample data for demonstration
        console.log('No real data, using sample data for demonstration');
        monthsData = ['Jan 2024', 'Feb 2024', 'Mar 2024', 'Apr 2024', 'May 2024', 'Jun 2024'];
        revenueData = [12000, 15000, 18000, 14000, 22000, 25000];
        profitData = [3000, 4000, 5000, 2000, 7000, 8000];
        costData = [9000, 11000, 13000, 12000, 15000, 17000];
        hasData = true;
    }

    // Financial Performance Chart
    const ctx = document.getElementById('financialChart');
    if (!ctx) {
        console.error('Canvas element not found!');
        return;
    } else {
        console.log('Canvas found, creating chart...');
        const chartCtx = ctx.getContext('2d');

        console.log('Creating chart with data:', { monthsData, revenueData, profitData, costData });
        
        try {
            const financialChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: monthsData,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Profit',
                            data: profitData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Costs',
                            data: costData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            radius: 6,
                            hoverRadius: 8
                        }
                    }
                }
            });
            console.log('Chart created successfully!');
        } catch (error) {
            console.error('Error creating chart:', error);
            document.getElementById('no-data-message').innerHTML = '<p>Error creating chart: ' + error.message + '</p>';
            document.getElementById('no-data-message').style.display = 'block';
            document.getElementById('financialChart').style.display = 'none';
        }
    }
});
</script>
    
{% endblock %}
