{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-greeting">
    <h2>Good morning, {{ display_name }}!</h2>
</div>
<h1>Undiscovered Destinations - Business Intelligence Dashboard</h1>
<div class="dashboard-main-row">
    <div class="ai-agent-interface">
        <h2>AI Agent</h2>
        <div class="ai-agent-placeholder">AI agent interface goes here.</div>
    </div>
    <div class="dashboard-cards">
        <div class="dashboard-card" id="total-revenue">
            <h2>Total Revenue</h2>
            <div class="card-value">£{{ total_revenue|floatformat:0 }}</div>
            <div class="card-subtitle">From all departures</div>
        </div>
        <div class="dashboard-card" id="customer-engagement">
            <h2>Customer Engagement</h2>
            <div class="card-value">{{ customer_engagement_rate }}%</div>
            <div class="card-subtitle">{{ customers_with_bookings|default:0 }}/{{ total_customers }} customers with bookings</div>
        </div>
        <div class="dashboard-card" id="tour-occupancy">
            <h2>Tour Occupancy</h2>
            <div class="card-value">{{ occupancy_rate }}%</div>
            <div class="card-subtitle">{{ total_booked }}/{{ total_capacity }} spots filled</div>
        </div>
        <div class="dashboard-card" id="total-tours">
            <h2>Active Tours</h2>
            <div class="card-value">{{ total_tours }}</div>
            <div class="card-subtitle">Tours in portfolio</div>
        </div>
    </div>
</div>

<!-- Most Profitable Tours Section -->
<div class="profitable-tours-section">
    <h2>Most Profitable Tours</h2>
    <div class="tours-grid">
        {% for tour in profitable_tours %}
        <div class="tour-card">
            {% if tour.image %}
                <div class="tour-image">
                    <img src="{{ tour.image.url }}" alt="{{ tour.title }}">
                </div>
            {% elif tour.image_url %}
                <div class="tour-image">
                    <img src="{{ tour.image_url }}" alt="{{ tour.title }}">
                </div>
            {% endif %}
            <div class="tour-content">
                <h3 class="tour-title">{{ tour.title }}</h3>
                <p class="tour-destination">{{ tour.destination }}</p>
                <div class="tour-details">
                    <span class="tour-duration">{{ tour.duration_days }} days</span>
                    <span class="tour-price">
                        {% if tour.pricing_type == 'per_person' %}
                            £{{ tour.price_per_person|floatformat:0 }} PPP
                        {% else %}
                            £{{ tour.price_per_group|floatformat:0 }} Group
                        {% endif %}
                    </span>
                    <span class="tour-difficulty {{ tour.difficulty_level }}">{{ tour.get_difficulty_level_display }}</span>
                </div>
                <div class="profitability-indicator profitable">
                    <span class="profit-label">Profitability:</span>
                    <span class="profit-value">High</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-tours">No tours available for analysis.</div>
        {% endfor %}
    </div>
</div>

<!-- Loss-Making Tours Section -->
<div class="loss-making-tours-section">
    <h2>Loss-Making Tours</h2>
    <div class="tours-grid">
        {% for tour in loss_making_tours %}
        <div class="tour-card loss-making">
            {% if tour.image %}
                <div class="tour-image">
                    <img src="{{ tour.image.url }}" alt="{{ tour.title }}">
                </div>
            {% elif tour.image_url %}
                <div class="tour-image">
                    <img src="{{ tour.image_url }}" alt="{{ tour.title }}">
                </div>
            {% endif %}
            <div class="tour-content">
                <h3 class="tour-title">{{ tour.title }}</h3>
                <p class="tour-destination">{{ tour.destination }}</p>
                <div class="tour-details">
                    <span class="tour-duration">{{ tour.duration_days }} days</span>
                    <span class="tour-price">
                        {% if tour.pricing_type == 'per_person' %}
                            £{{ tour.price_per_person|floatformat:0 }} PPP
                        {% else %}
                            £{{ tour.price_per_group|floatformat:0 }} Group
                        {% endif %}
                    </span>
                    <span class="tour-difficulty {{ tour.difficulty_level }}">{{ tour.get_difficulty_level_display }}</span>
                </div>
                <div class="profitability-indicator loss-making">
                    <span class="profit-label">Status:</span>
                    <span class="profit-value">Low Performance</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-tours">No loss-making tours identified.</div>
        {% endfor %}
    </div>
</div>

<!-- Upcoming Departures -->
<div class="dashboard-card upcoming-departures-card">
    <h2>Upcoming Departures</h2>
    <div class="upcoming-departures-list">
        {% for dep in departures %}
        <div class="departure-item">
            <div class="departure-title">{{ dep.title }}</div>
            <div class="departure-country">{{ dep.country }}</div>
            <div class="departure-details">
                {{ dep.duration_days }} days | {{ dep.departure_date }} | {{ dep.group_size_current }}/{{ dep.group_size_max }} | 
                {% if dep.pricing_type == 'per_person' %}
                    £{{ dep.price_per_person|floatformat:0 }} PPP
                {% else %}
                    £{{ dep.price_per_group|floatformat:0 }} Group
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="departure-item">No upcoming departures.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}
